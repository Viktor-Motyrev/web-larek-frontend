# WebLarek

WebLarek — это учебное приложение для оформления заказов с витриной товаров, реализованное на TypeScript с архитектурой MVP.

---

## Стек технологий

- **HTML** — разметка страниц
- **SCSS** — стилизация интерфейса
- **TypeScript** — типизированная логика приложения
- **Webpack** — сборка и оптимизация проекта

---

## Структура проекта

```
src/
├── components/         # UI-компоненты
│   └── base/           # Базовые компоненты и наследование
├── pages/
│   └── index.html      # Главная страница
├── scss/
│   └── styles.scss     # Основные стили
├── types/
│   └── index.ts        # Описание типов данных
├── utils/
│   ├── constants.ts    # Константы
│   └── utils.ts        # Вспомогательные функции
└── index.ts            # Точка входа приложения
```

---

## Установка и запуск

1. Установите зависимости:

   ```bash
   npm install
   # или
   yarn
   ```

2. Запустите проект в режиме разработки:

   ```bash
   npm run start
   # или
   yarn start
   ```

3. Для сборки проекта используйте:

   ```bash
   npm run build
   # или
   yarn build
   ```

---

## Архитектура

Проект построен по паттерну **MVP (Model-View-Presenter)**:

- **Model** — отвечает за работу с данными и API (`Api`, типы данных)
- **View** — реализует отображение интерфейса (наследники `Component`)
- **Presenter** — связывает Model и View, управляет логикой и событиями (`EventEmitter`)

---

## Взаимодействие частей

**Взаимодействие происходит через EventEmitter:**
1. Пользователь совершает действие во View (например, нажимает кнопку).
2. View генерирует событие через EventEmitter.
3. Presenter слушает событие, вызывает соответствующий метод Model.
4. Model изменяет данные и может сгенерировать новое событие.
5. Presenter обновляет View, вызывая методы рендера.

---

## Основные классы и их назначение

### Базовый код

#### Класс `Api`
Реализует базовую логику отправки HTTP-запросов. В конструктор передаётся базовый адрес сервера и, при необходимости, объект с заголовками.  
**Методы:**
- `get(endpoint)` — выполняет GET-запрос на указанный эндпоинт, возвращает промис с ответом сервера.
- `post(endpoint, data, method = 'POST')` — отправляет данные в формате JSON на указанный эндпоинт. Метод запроса можно переопределить.

#### Класс `EventEmitter`
Брокер событий для подписки и генерации событий в приложении. Используется для связи между слоями.
- `on(event, handler)` — подписка на событие.
- `emit(event, data)` — генерация события.

#### Класс `Component<T>`
Базовый дженерик-класс для всех UI-компонентов (View). В конструктор передаётся DOM-элемент-контейнер.
- `render(data?: Partial<T>)` — обновляет содержимое компонента.
- `changeClassState(element, className, state?)` — изменяет состояние CSS-класса.
- `changeDisabledState(element, isDisabled)` — управляет атрибутом `disabled`.

---

### Слой данных

#### Класс `Showcase`
Отвечает за хранение и управление карточками товаров.
- `constructor(events: IEvents)`  
  Создаёт экземпляр витрины товаров, принимает объект событий для обработки пользовательских действий.
- `set items(items: IItem[])`  
  Устанавливает список товаров для отображения на витрине.
- `get items()`  
  Возвращает текущий список товаров витрины.
- `getItem(itemId: string)`  
  Возвращает товар по его идентификатору из списка витрины.

#### Класс `Basket`
Хранит товары, добавленные в корзину.
- `constructor(events: IEvents)`  
  Создаёт экземпляр корзины, принимает объект событий для обработки пользовательских действий.
  - `itemIds: Set<string>`  
  Множество идентификаторов товаров в корзине.
- `addItem(itemId: string): void`  
  Добавляет товар в корзину по его идентификатору.
- `get items()`  
  Возвращает список товаров, добавленных в корзину.
- `removeItem(itemId: string)`  
  Удаляет товар из корзины по его идентификатору.
- `alreadyInBasket(itemId: string)`  
  Проверяет, находится ли товар с указанным идентификатором в корзине.
  - `clear(): void`  
  Очищает корзину.
- `getTotal()`  
  Возвращает общую стоимость всех товаров в корзине.
- `getCount()`  
  Возвращает количество товаров в корзине.

#### Класс `Order`
Хранит и валидирует данные заказа.
- `constructor(events: IEvents)`  
  Создаёт экземпляр заказа, принимает объект событий для обработки пользовательских действий.
- `clear()`  
  Очищает все данные заказа.
- Сеттеры и геттеры для полей заказа (`id`, `address`, `phone`, `email`, `payment`)  
  Позволяют установить или получить значения соответствующих полей заказа.
- `validateOrderForm(msg: string)`  
  Проверяет корректность заполнения формы заказа, возвращает результат валидации и сообщение об ошибке.
- `validateContactForm(msg: string)`  
  Проверяет корректность заполнения контактных данных, возвращает результат валидации и сообщение об ошибке.
- `setFieldData(field, value)`  
  Устанавливает значение указанного поля заказа.
- `getOrderData()`  
  Возвращает объект с текущими данными заказа.

---

### Слой представления

Все классы отвечают за отображение данных внутри DOM-контейнеров.

#### Класс `Modal`
Модальное окно приложения. Управляет открытием/закрытием, обработкой событий клавиатуры и кликов.
- `constructor(container: HTMLElement, events: IEvents)`  
  Создаёт экземпляр модального окна, принимает DOM-контейнер и объект событий для обработки пользовательских действий.
- `open()`, `close()`  
  Открывает или закрывает модальное окно, а также управляет обработчиками событий клавиатуры и кликов для корректной работы модали.

#### Класс `FormView`
Базовый класс формы, используется внутри `Modal`.
- `constructor(form: HTMLFormElement, events: IEvents)`  
  Создаёт экземпляр формы, принимает DOM-элемент формы и объект событий для обработки пользовательских действий.
- `set valid(value: boolean)`  
  Устанавливает состояние валидности формы.
- `set errors(message: string)`  
  Отображает сообщение об ошибке или скрывает его, если ошибок нет.

#### Класс `ContactsFormView`
Форма для ввода контактных данных.
- `constructor(container: HTMLFormElement, events: IEvents)`  
  Создаёт экземпляр формы для ввода контактных данных, принимает DOM-элемент формы и объект событий.
- `set email(value: string)`  
  Устанавливает значение поля email в форме.
- `set phone(value: string)`  
  Устанавливает значение поля телефона в форме.

#### Класс `OrderFormView`
Форма для оформления заказа.
- `constructor(container: HTMLFormElement, events: IEvents)`  
  Создаёт экземпляр формы для оформления заказа, принимает DOM-элемент формы и объект событий.
- `set address(value: string)`  
  Устанавливает значение поля адреса в форме.
- `set payment(method: TPaymentType)`  
  Устанавливает выбранный способ оплаты в форме.

#### Класс `SuccessView`
Отображает результат успешного оформления заказа.
- `constructor(container: HTMLElement, events: IEvents)`  
  Создаёт экземпляр окна успешного оформления заказа, принимает DOM-контейнер и объект событий.
- `set total(value: number)`  
  Устанавливает и отображает итоговую сумму заказа в окне успешного оформления.

#### Класс `BasketView`
Список товаров в корзине.
- `constructor(container: HTMLElement, events: IEvents)`  
  Создаёт экземпляр представления корзины, принимает DOM-контейнер и объект событий.
- `set items(items: HTMLElement[])`  
  Устанавливает и отображает список товаров в корзине.
- `set total(price: number)`  
  Устанавливает и отображает итоговую стоимость товаров в корзине.

#### Класс `CardView` и наследники
Базовый класс карточки товара. От него наследуются:
- `CardShowcase` — карточка на витрине
- `CardBasket` — карточка в корзине
- `CardPreview` — карточка в предпросмотре

**Общие свойства:**
- `set category(value: TItemCategory)`  
  Устанавливает категорию товара для карточки.
- `set image(value: string)`  
  Устанавливает изображение товара в карточке.
- `set price(value: number | null)`  
  Устанавливает цену товара в карточке.
- `set description(value: string)`  
  Устанавливает описание товара в карточке.
- `set id(value: string)`  
  Устанавливает идентификатор товара для карточки.
- `set title(value: string)`  
  Устанавливает название товара в карточке.
- `set itemIndex(value: number)`  
  Устанавливает порядковый номер карточки (например, для отображения позиции в списке).
- `set inBasket(value: boolean)`  
  Устанавливает состояние "добавлено в корзину" для карточки товара.

#### Класс `AppPage`
Главная страница приложения.
- `constructor(container: HTMLElement, events: IEvents)`  
  Создаёт экземпляр главной страницы приложения, принимает DOM-контейнер и объект событий.
- `set galleryItems(items: HTMLElement[])`  
  Устанавливает и отображает список карточек товаров на главной странице.
- `set basketCount(value: number)`  
  Устанавливает и отображает количество товаров в корзине.
- `set scrollLocked(isLocked: boolean)`  
  Блокирует или разблокирует прокрутку страницы (например, при открытии модального окна).

#### Класс `AppApi`
Обеспечивает взаимодействие с сервером через экземпляр класса `Api`.

constructor(baseApi: IApi)
- `getShowcase(): Promise<IItem[]>` - возращает все доступные карточки
- `getItemById(id: string): Promise<IItem>` - возвращает одну карточку её id
- `postOrder(order: IOrderData, items: IItem[], cost: number): Promise<IOrderResponse>` - отправляет на сервер данные заказа и получает потдверждение этого заказа

---

## Типы данных

В приложении используются следующие основные типы данных:

### Категории товаров

```ts
type ItemCategory = 'софт скил' | 'хард-скил' | 'другое' | 'кнопка' | 'дополнительное';

const CategoryMapping: Record<ItemCategory, string> = {
  'софт-скил': 'soft',
  'хард-скил': 'hard',
  'другое': 'other',
  'кнопка': 'button',
  'дополнительное': 'additional',
};
```

### Описание товара

- **ServerItem** — структура товара, получаемого с сервера

  ```ts
  interface ServerItem {
    id: string;
    description: string;
    category: ItemCategory;
    image: string;
    price: number | null;
    title: string;
  }
  ```

- **Item** — расширенный тип для клиента, включает порядковый номер и флаг "в корзине":

  ```ts
  interface Item extends ServerItem {
    itemIndex: number;
    inBasket: boolean;
  }
  ```

### Витрина товаров

```ts
interface Showcase {
  items: Item[];
  getItem(id: string): Item | undefined;
}
```

### Корзина

В корзине хранятся только идентификаторы товаров:

```ts
interface Basket {
  itemIds: Set<string>;
  addItem(itemId: string): void;
  alreadyInBasket(itemId: string): boolean;
  clear(): void;
  getTotal(items: Item[]): number;
  getCount(): number;
  removeItem(itemId: string): void;
}
```

### Оформление заказа

- **Способы оплаты:**

  ```ts
  type PaymentMethod = 'card' | 'cash' | 'null';
  ```

- **Данные формы заказа:**

  ```ts
  interface OrderFormData {
    address: string;
    email: string;
    payment: PaymentMethod;
    phone: string;
  }
  ```

- **Интерфейс заказа:**

  ```ts
  interface Order extends OrderFormData {
    clear(): void;
    getOrderData(): OrderFormData;
  }
  ```

### Работа с API

```ts
type ApiMethod = 'POST' | 'PUT' | 'DELETE' | 'PATCH';

interface ApiClient {
  baseUrl: string;
  get<T>(uri: string): Promise<T>;
  post<T>(uri: string, data: object, method?: ApiMethod): Promise<T>;
}
```

### Результат оформления заказа

```ts
interface OrderResult {
  id?: string;
  total?: number;
  error?: string;
  code?: number;
}
```


## Пример сценария взаимодействия

1. Пользователь на главной странице нажимает кнопку "В корзину" на карточке товара (`CardShowcase`).
2. Компонент карточки генерирует событие через [`EventEmitter`](src/components/base/events.ts).
3. Презентер (Presenter) подписан на это событие и вызывает метод модели корзины (`Basket.addItem(item)`).
4. Модель корзины обновляет свои данные и генерирует событие об изменении содержимого корзины.
5. Презентер получает это событие и обновляет представление корзины (`BasketView`), а также счетчик товаров на главной странице (`AppPage.basketCount`).
6. Пользователь открывает корзину, видит добавленные товары, нажимает "Оформить".
7. Открывается форма заказа (`OrderFormView`). Пользователь вводит адрес и выбирает способ оплаты.
8. После заполнения формы и валидации данных генерируется событие оформления заказа.
9. Презентер собирает данные заказа и отправляет их на сервер через [`AppApi.postOrder`].
10. После успешного ответа сервера отображается окно успешного оформления заказа (`SuccessView`), корзина очищается.

---

